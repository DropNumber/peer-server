// Generated by CoffeeScript 1.6.2
(function() {
  'Tracks user-uploaded files, and their edit/production state.';
  var _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.ServerFileCollection = (function(_super) {
    __extends(ServerFileCollection, _super);

    function ServerFileCollection() {
      this.forEachDevelopmentFile = __bind(this.forEachDevelopmentFile, this);
      this.createProductionVersion = __bind(this.createProductionVersion, this);
      this.getContents = __bind(this.getContents, this);
      this.isDynamic = __bind(this.isDynamic, this);
      this.hasFile = __bind(this.hasFile, this);
      this.comparator = __bind(this.comparator, this);
      this.checkForNoFiles = __bind(this.checkForNoFiles, this);      _ref = ServerFileCollection.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    ServerFileCollection.prototype.model = ServerFile;

    ServerFileCollection.prototype.localStorage = new Backbone.LocalStorage("ServerFileCollection");

    ServerFileCollection.prototype.initialize = function() {
      return this.fetch({
        success: this.checkForNoFiles
      });
    };

    ServerFileCollection.prototype.checkForNoFiles = function() {
      var index, notFound;

      if (this.length > 0) {
        return;
      }
      index = new ServerFile({
        name: "index.html",
        size: 0,
        type: "text/html",
        contents: this.indexTemplate,
        isRequired: true
      });
      notFound = new ServerFile({
        name: "404.html",
        size: 0,
        type: "text/html",
        contents: this.notFoundTemplate,
        isRequired: true
      });
      this.add(index);
      this.add(notFound);
      index.save();
      notFound.save();
      return this.createProductionVersion();
    };

    ServerFileCollection.prototype.comparator = function(serverFile) {
      return serverFile.get("name");
    };

    ServerFileCollection.prototype.getLandingPage = function() {
      var data, landingPage;

      landingPage = this.find(function(serverFile) {
        return serverFile.get("name") === "index.html" && serverFile.get("isProductionVersion");
      });
      if (landingPage) {
        data = {
          fileContents: landingPage.get("contents"),
          filename: landingPage.get("name"),
          type: "text/html"
        };
      } else {
        data = {
          fileContents: this.indexTemplate,
          filename: "index.html",
          type: "text/html"
        };
      }
      return data;
    };

    ServerFileCollection.prototype.hasFile = function(filename) {
      return this.findWhere({
        name: filename
      });
    };

    ServerFileCollection.prototype.isDynamic = function(filename) {
      return this.findWhere({
        name: filename
      }).isDynamic();
    };

    ServerFileCollection.prototype.getContents = function(filename) {
      var contents, serverFile;

      serverFile = this.findWhere({
        name: filename,
        isProductionVersion: true
      });
      contents = "";
      if (serverFile) {
        contents = serverFile.get("contents");
      }
      return contents;
    };

    ServerFileCollection.prototype.createProductionVersion = function() {
      var developmentFiles, productionFiles,
        _this = this;

      productionFiles = this.where({
        isProductionVersion: true
      });
      _.each(productionFiles, function(serverFile) {
        return serverFile.destroy();
      });
      developmentFiles = this.where({
        isProductionVersion: false
      });
      return _.each(developmentFiles, function(serverFile) {
        var attrs, copy;

        attrs = _.clone(serverFile.attributes);
        attrs.id = null;
        copy = new ServerFile(attrs);
        copy.set("isProductionVersion", true);
        _this.add(copy);
        return copy.save();
      });
    };

    ServerFileCollection.prototype.forEachDevelopmentFile = function(fn) {
      return this.each(function(serverFile) {
        if (!serverFile.get("isProductionVersion")) {
          return fn(serverFile);
        }
      });
    };

    ServerFileCollection.prototype.indexTemplate = "<html>\n  <body>\n    Hello, world.\n  </body>\n</html>";

    ServerFileCollection.prototype.notFoundTemplate = "<html>\n  <body>\n    404 - page not found\n  </body>\n</html>";

    return ServerFileCollection;

  })(Backbone.Collection);

}).call(this);
